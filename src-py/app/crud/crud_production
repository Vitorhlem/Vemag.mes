# Localização: src-py/app/crud/crud_production.py
from sqlalchemy.ext.asyncio import AsyncSession
from app.models.production_model import ProductionAppointment
from datetime import datetime

class CRUDProduction:
    async def create_appointment(self, db: AsyncSession, *, obj_in: dict, org_id: int) -> ProductionAppointment:
        """
        Cria um registro oficial de apontamento vindo do cockpit.
        """
        # Limpeza e tratamento das datas (ISO String para Python Naive Datetime)
        start_time = datetime.fromisoformat(obj_in["start_time"].replace('Z', '+00:00')).replace(tzinfo=None)
        end_time = datetime.fromisoformat(obj_in["end_time"].replace('Z', '+00:00')).replace(tzinfo=None)

        db_obj = ProductionAppointment(
            vehicle_id=obj_in.get("vehicle_id") or obj_in.get("machine_id"),
            operator_id=str(obj_in.get("operator_id") or obj_in.get("operator_badge")),
            op_number=obj_in.get("op_number"),
            position=obj_in.get("position"),
            operation_code=obj_in.get("operation"),
            start_time=start_time,
            end_time=end_time,
            produced_qty=float(obj_in.get("produced_qty", 0.0)),
            scrap_qty=float(obj_in.get("scrap_qty", 0.0)),
            appointment_type=obj_in.get("appointment_type", "PRODUCTION"),
            stop_reason=obj_in.get("stop_reason"),
            sap_status="PENDING" # Inicia aguardando o processamento do Celery -> SAP
        )

        db.add(db_obj)
        await db.commit()
        await db.refresh(db_obj)
        return db_obj

# Instancia para ser usada como crud.production
production = CRUDProduction()